---
title: "Exploring Kriging Models for Interpolating NO2 Values"
output:
  html_document:
    toc: true
    theme: united
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data Preparation

## load libraries
```{r,warning=FALSE,message=FALSE}

library(gstat)
library(tidyverse)
library(viridis)
library(sf)
library(stars)
library(patchwork)

```

## Load dataset.

```{r,warning=FALSE,message=FALSE}
no2 <- read_csv(system.file("external/no2.csv", 
                            package = "gstat"), show_col_types = FALSE)


```

## explore dataset
Displaying the first three rows of the 'no2' dataset to get a quick overview of NO2 values
```{r,warning=FALSE,message=FALSE}
head(data.frame(no2), 3)
```

## change geom coodinates.
Transforming the 'no2' dataset into a spatial sf object with CRS set to EPSG:32632 for further geographic analysis

```{r,warning=FALSE,message=FALSE}
crs <- st_crs("EPSG:32632")
no2.sf <- st_as_sf(no2, crs = "OGC:CRS84", coords = 
                     c("station_longitude_deg", "station_latitude_deg")) |>
  st_transform(crs) 
no2.sf
```


## Read and transform spatial data, then plot it
```{r,warning=FALSE,message=FALSE}
map <- read_sf("de_nuts1.gpkg") |> st_transform(crs) 

ggplot() + geom_sf(data = map) + 
  geom_sf(data = no2.sf, mapping = aes(col = NO2)) + 
  scale_color_viridis()
```

## Prepare grid.

# IDW Interpolation.

### Grid preperation
Create a grid from bounding box of spatial data, with cell size 10,000, then crop it to spatial data extent
```{r,warning=FALSE,message=FALSE}
grid <- st_bbox(map) |>
  st_as_stars(dx = 10000) |> st_crop(map) 
grid
```

## Plot interpolated values
```{r,warning=FALSE,message=FALSE}
interpolated.values <- idw(NO2~1, no2.sf, grid)

ggplot() + geom_stars(data = interpolated.values, 
                      aes(fill = var1.pred, x = x, y = y)) + 
  geom_sf(data = st_cast(map, "MULTILINESTRING")) + 
  geom_sf(data = no2.sf, col="red") + scale_fill_viridis() 

```
ide by side chart for easy comparition
```{r,warning=FALSE,message=FALSE}
p1 <- ggplot() + geom_sf(data = map) +  geom_sf(data = no2.sf, mapping = aes(col = NO2)) + scale_color_viridis()
p2 <- ggplot() + geom_stars(data = interpolated.values, 
                            aes(fill = var1.pred, x = x, y = y)) + geom_sf(data = st_cast(map, "MULTILINESTRING")) + geom_sf(data = no2.sf, col="red") + scale_fill_viridis() 
p1|p2
```

# Kriging 

## Variogram creation
```{r,warning=FALSE,message=FALSE}
vcloud <- variogram(NO2~1, no2.sf, cloud=TRUE)

```

## plot the variogram.
```{r,warning=FALSE,message=FALSE}
v2 <- variogram(NO2~1, no2.sf, cutoff = 100000, width = 10000)
plot(v2, plot.numbers = TRUE, xlab = "distance h [m]",
     ylab = expression(gamma(h)),
     xlim = c(0, 1.055 * max(v2$dist)))
```

## variogram values.
```{r,warning=FALSE,message=FALSE}
vgm()
```
## check all variogram for find a mapping.
```{r,warning=FALSE,message=FALSE}
show.vgms(par.strip.text=list(cex=0.75))
```

## fit the variogram.
```{r,warning=FALSE,message=FALSE}

v1 <- variogram(NO2~1, no2.sf)
v.m <- fit.variogram(v1, vgm(psill=20, model = "Exp", range = 20000, nugget = 1))
plot(v1, v.m)

```
## check for isotropiness
As shown in the graph below, the patterns appear similar at all selected angles, leading us to assume that the dataset is isotropic

```{r,warning=FALSE,message=FALSE}
v1.ani <- variogram(NO2~1, alpha = c(0, 45, 90, 135), no2.sf)
fit.ani <- vgm(psill=20, model = "Exp", range = 25000, nugget = 3, anis = c(30, 10, 0, 0.5, 0.3))
plot(v1.ani, fit.ani)
```

## krigging.
### krigin with v.m.
```{r,warning=FALSE,message=FALSE}
krigOK <- krige(NO2~1, no2.sf, grid, v.m)
```
### krigin with fit.ani
```{r,warning=FALSE,message=FALSE}
krigOK2 <- krige(NO2~1, no2.sf, grid,fit.ani)
```

## plot the interpolated values with krigin.
```{r,warning=FALSE,message=FALSE}

ggplot() + geom_stars(data =krigOK, 
                      aes(fill = var1.pred, x = x, y = y)) + 
  geom_sf(data = st_cast(map, "MULTILINESTRING")) + 
  geom_sf(data = no2.sf, col="red") + scale_fill_viridis() 
```

