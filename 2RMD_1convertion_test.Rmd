---
title: 'Analysis of Kriging modeling of zinc in Meuse river'
output:
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Methodology

Our analysis commenced with the exploration and preparation of the "Meuse" dataset using essential libraries such as gstat, tidyverse, viridis, sf, sp, stars, patchwork, and ggplot2. This step involved loading the dataset into the R session and inspecting its structure using class() and head() functions to ensure data integrity and gain initial insights into the variables.

Subsequently, the "Meuse" dataset was converted into a spatial feature object (sf) using the st_as_sf() function, with spatial coordinates set to the columns "x" and "y". This transformation facilitated spatial analysis and visualization, enabling the plotting of the dataset using ggplot2 with adjusted parameters for enhanced readability and clarity.

To further enrich our analysis, the "meuse.grid" dataset containing gridded environmental variables was loaded. Spatial coordinates for this dataset were also set to columns "x" and "y" using the coordinates() function, ensuring alignment with the "Meuse" dataset for subsequent spatial analysis and modeling tasks.

Our analysis then proceeded with the implementation of interpolation techniques, starting with Inverse Distance Weighting (IDW). IDW was applied using the idw() function to estimate zinc concentrations across the study area. Predicted values were extracted and converted to a data frame for further analysis and visualization.

Following IDW interpolation, kriging modeling was conducted to provide more sophisticated spatial predictions of zinc concentrations. Exploratory Data Analysis (EDA) was performed to identify relationships in the zinc distribution, guiding model selection and parameterization.

Three kriging approaches were explored: Ordinary Kriging (OK), Universal Kriging, and Regression Kriging. Each approach involved variogram analysis, model fitting, and kriging prediction. Predicted values were plotted using ggplot2 for visual comparison and evaluation.

Finally, the predictions from all kriging approaches and IDW interpolation were juxtaposed using patchwork to facilitate comparison and assessment of their performance in predicting zinc concentrations across the study area. This comprehensive methodology allowed for a thorough exploration and analysis of kriging modeling for zinc in the Meuse river region.

## Load necessary libraries
```{r,warning=FALSE,message=FALSE}
library(gstat)
library(tidyverse)
library(viridis)
library(sf)
library(sp)
library(stars)
library(patchwork)
library(ggplot2)
```

##loads the dataset named "meuse" into the current R session.check the data type. show the head
```{r,warning=FALSE,message=FALSE}
data(meuse)
class(meuse)
head(meuse)
```


##Convert the "meuse" dataset to a spatial feature object (sf) with coordinates "x" and "y".
```{r,warning=FALSE,message=FALSE}
meuse_sf <- st_as_sf(meuse, coords = c("x", "y"))
```

# Plot using ggplot2 with adjusted parameters


```{r,warning=FALSE,message=FALSE}
ggplot() +
  geom_sf(data = meuse_sf, aes(color = zinc), size = 2, alpha = 0.7) +
  scale_color_viridis() +
  theme_minimal() + # reduce unnecessary clutter
  theme(axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels
        axis.title = element_text(size = 14))  +  # Adjust axis title size
  labs(x = "X Coordinate", y = "Y Coordinate")  # Add axis labels
```

##Load the "meuse.grid" dataset containing gridded environmental variables for spatial analysis and modeling.
```{r,warning=FALSE,message=FALSE}
data(meuse.grid)
```


## Set the spatial coordinates for "meuse.grid" dataset to columns "x" and "y".
```{r,warning=FALSE,message=FALSE}
coordinates(meuse) <- c("x", "y")
coordinates(meuse.grid) <- c("x", "y")

```

# Perform Inverse Distance Weighting (IDW)

```{r,warning=FALSE,message=FALSE}
zinc.idw <- idw(zinc ~ 1, meuse, meuse.grid)
```

# Extract predicted values
```{r,warning=FALSE,message=FALSE}
zinc_idw_pred <- data.frame(coordinates(meuse.grid), zinc = zinc.idw$var1.pred)
```

# Convert to data.frame
```{r,warning=FALSE,message=FALSE}
zinc_idw_df <- as.data.frame(zinc_idw_pred)
```

# Plot using ggplot2
# Plot using ggplot2 with aspect ratio adjustment
```{r,warning=FALSE,message=FALSE}
ggplot(zinc_idw_df, aes(x = x, y = y, fill = zinc)) +
  geom_tile() +
  scale_fill_viridis() +
  labs(fill = "Predicted Zinc") +
  theme_minimal() +
  coord_equal()
```


# Start Kriging.


# prior to that just do some EDA to identify relationship in zinc disrtibution.

```{r,warning=FALSE,message=FALSE}
ggplot(meuse_sf,aes(y=zinc,x=dist))+geom_point()
```

```{r,warning=FALSE,message=FALSE}
ggplot(meuse_sf,aes(y=log(zinc),x=sqrt(dist)))+geom_point()
```


## kriging 001 
```{r,warning=FALSE,message=FALSE}

vgmUni=variogram(log(zinc)~sqrt(dist),alpha = c(0, 45, 90, 135), meuse)

vgmUK.fit = fit.variogram(vgmUni,  model = vgm(1, "Sph", 900, 1))

k11<- krige(log(zinc) ~ 1, meuse, meuse.grid, model = vgmUK.fit )
k11_df <- data.frame(coordinates(meuse.grid), zinc_predicted = k11$var1.pred)

plot(vgmUni,vgmUK.fit )
```

## kriging 002 Universal kriging

```{r,warning=FALSE,message=FALSE}
lm.model<-lm(log(zinc)~sqrt(dist),data=meuse)

residual<-residuals(lm.model)

v1.residual <- variogram(residual~1,alpha = c(0, 45, 90, 135), meuse)

vm.resid<- fit.variogram(v1.residual ,  model = vgm(1, "Sph", 900, 1))

k22<- krige(log(zinc) ~ sqrt(dist), meuse, meuse.grid, model = vm.resid )
k22_df <- data.frame(coordinates(meuse.grid), zinc_predicted = k22$var1.pred)

plot(v1.residual, vm.resid)
```

## kriging 003 OK

#vgm1 = variogram(log(zinc)~1, meuse)
#plot(variogram(log(zinc)~1, meuse, cloud=TRUE))

#vgm1.fit = fit.variogram(vgm1, model = vgm(1, "Sph", 900, 1))
# vgm1.fit

# plot(vgm1, vgm1.fit)


# Fit variogram
```{r,warning=FALSE,message=FALSE}
vgm5 <- variogram(log(zinc) ~ 1, meuse)
vgm5.fit <- fit.variogram(vgm5, model = vgm(psill = 1, model = "Sph", range = 900, nugget = 1))

# Perform kriging
lzn.okriging <- krige(log(zinc) ~ 1, meuse, meuse.grid, model = vgm5.fit)

# Extract predicted values
kriged_df <- data.frame(coordinates(meuse.grid), zinc_predicted = lzn.okriging$var1.pred)
```
# Plot using ggplot2
```{r,warning=FALSE,message=FALSE}
ggplot(kriged_df, aes(x = x, y = y, fill = zinc_predicted)) +
  geom_tile() +
  scale_fill_viridis() +
  labs(fill = "Predicted Zinc") +
  theme_minimal()+
  coord_equal()

p1<-ggplot(zinc_idw_df, aes(x = x, y = y, fill = zinc)) +
  geom_tile() +
  scale_fill_viridis() +
  labs(fill = "Predicted Zinc",title = "IDW Predictions of Zinc") +
  theme_minimal() +
  coord_equal()
p2<-ggplot(kriged_df, aes(x = x, y = y, fill = zinc_predicted)) +
  geom_tile() +
  scale_fill_viridis() +
  labs(fill = "Predicted Zinc",title = "OK Kriged Predictions of Zinc") +
  theme_minimal()+
  coord_equal()

p3<-ggplot(k11_df, aes(x = x, y = y, fill = zinc_predicted)) +
  geom_tile() +
  scale_fill_viridis() +
  labs(fill = "Predicted Zinc",title = "Universal kriging Predictions of Zinc") +
  theme_minimal() +
  coord_equal()

p4<-ggplot(k22_df, aes(x = x, y = y, fill = zinc_predicted)) +
  geom_tile() +
  scale_fill_viridis() +
  labs(fill = "Predicted Zinc",title = "regression Krigin Predictions of Zinc") +
  theme_minimal()+
  coord_equal()

 p1 + p2 + p3 + p4


```